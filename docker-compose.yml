# Alexa-OS: Voice Assistant Stack
# Run with: docker-compose up -d
# For development: docker-compose up --build
#
# All configuration via .env file - copy .env.example to .env and customize

services:
  # LiveKit Server - Real-time audio/video backbone
  livekit:
    image: livekit/livekit-server:latest
    container_name: alexa-os-livekit
    ports:
      - "7880:7880"   # HTTP API & WebSocket
      - "7881:7881"   # RTC/WebRTC TCP
      - "7882:7882/udp"   # TURN/UDP
      - "50000-50100:50000-50100/udp"  # RTC port range
    environment:
      LIVEKIT_KEYS: "${LIVEKIT_API_KEY}: ${LIVEKIT_API_SECRET}"
    command: >
      --dev
      --bind 0.0.0.0
      --node-ip 127.0.0.1
    networks:
      - alexa-os-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7880"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Kokoro TTS - Local text-to-speech with OpenAI-compatible API
  kokoro:
    image: ghcr.io/remsky/kokoro-fastapi-cpu:v0.2.2
    container_name: alexa-os-kokoro
    ports:
      - "8880:8880"
    volumes:
      - kokoro_models:/app/models
    networks:
      - alexa-os-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8880/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    # For GPU acceleration, uncomment and use GPU image:
    # image: ghcr.io/remsky/kokoro-fastapi-gpu:v0.2.2
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]

  # Voice Agent - Local Whisper STT + LLM + Kokoro TTS
  voice-agent:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: alexa-os-agent
    depends_on:
      livekit:
        condition: service_healthy
      kokoro:
        condition: service_healthy
    environment:
      # LiveKit connection
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}
      - LIVEKIT_URL=ws://livekit:7880

      # STT - Local Whisper
      - STT_PROVIDER=${STT_PROVIDER:-whisper}
      - WHISPER_MODEL=${WHISPER_MODEL:-base.en}
      - WHISPER_DEVICE=${WHISPER_DEVICE:-auto}
      - WHISPER_LANGUAGE=${WHISPER_LANGUAGE:-en}

      # TTS - Kokoro (local container)
      - TTS_PROVIDER=${TTS_PROVIDER:-kokoro}
      - KOKORO_URL=http://kokoro:8880
      - KOKORO_VOICE=${KOKORO_VOICE:-af_bella}

      # LLM - Ollama
      - LLM_PROVIDER=${LLM_PROVIDER:-ollama}
      - OLLAMA_HOST=${OLLAMA_HOST}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.2}

      # Optional: Anthropic API
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}

      # Model cache
      - MODEL_CACHE_DIR=/app/models
    volumes:
      - whisper_models:/app/models
    networks:
      - alexa-os-network
    restart: unless-stopped

  # Redis for LiveKit session management
  redis:
    image: redis:7-alpine
    container_name: alexa-os-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - alexa-os-network
    restart: unless-stopped

networks:
  alexa-os-network:
    driver: bridge

volumes:
  redis_data:
  kokoro_models:
  whisper_models:
